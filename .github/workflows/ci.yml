name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    name: Build, Test, and Document
    runs-on: ubuntu-latest
    
    # This ensures the shell is properly initialized for Conda
    defaults:
      run:
        shell: bash -l {0}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Setup the Conda Environment
      - name: Setup Mamba/Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: test_env
          environment-file: environment.yml
          auto-activate-base: false
          miniforge-variant: Miniforge3
          use-mamba: true

      # 2. Configure CMake
      - name: Configure CMake
        run: |
          mkdir -p build
          cmake -B build -DCMAKE_BUILD_TYPE=Release

      # 3. Build the Project
      - name: Build
        run: cmake --build build -- -j$(nproc)

      # 4. Run Tests
      - name: Run Tests
        run: |
          cd build
          ctest --output-on-failure

      # 5. Build Documentation
      - name: Build Documentation
        run: |
          ./scripts/build_docs.sh

      # 6. Upload Documentation as an Artifact
      - name: Upload Docs Artifact
        uses: actions/upload-artifact@v4
        with:
          name: HTML-Documentation
          path: docs/_build/html
